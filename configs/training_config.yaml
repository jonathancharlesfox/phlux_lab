# ======================================================================
# PHLUX – STACKED VFM TRAINING CONFIGURATION
# Flow → Wear → Flow Correction
# ======================================================================

project:
  name: phlux_vfm_stacked
  client_name: ClientA
  version: v1
  unit_system: SI
  random_seed: 42


# ======================================================================
# GLOBAL PATHS
# ======================================================================

paths:
  data_root: phlux_lab/data/synthetic
  model_root: phlux_lab/models/ClientA


# ======================================================================
# GLOBAL TRAINING DEFAULTS
# ======================================================================

training_defaults:
  batch_size: 128
  epochs: 150
  learning_rate: 0.001
  validation_split: 0.05
  early_stopping: true
  patience: 15

reduce_lr_on_plateau:
  enabled: true
  monitor: val_loss
  factor: 0.5
  patience: 3
  min_lr: 1.0e-6
  cooldown: 0


# ======================================================================
# FEATURE PREPROCESSING
# ======================================================================

preprocessing:

  scaling:
    method: standard   # standard | minmax | none

  clipping:
    enabled: true

  noise:
    enabled: true
    features:
      # σ = standard deviation of additive Gaussian noise applied per sample during training (in raw data units)

      suction_pressure:   0.05
      discharge_pressure: 0.05
      speed:              0.02
      valve_opening:      0.01

  feature_engineering:
    - name: delta_pressure
      type: subtract
      inputs: [discharge_pressure, suction_pressure]
      apply_to: ["flow", "wear", "flow_correction"]

    - name: specific_power
      type: divide
      inputs: [pump_power, q_liquid_pred]
      eps: 1.0e-6
      apply_to: ["wear", "flow_correction"]


# ======================================================================
# MODEL DEFINITIONS
# ======================================================================

models:

  # --------------------------------------------------------------------
  # FLOW MODEL (BASE)
  # --------------------------------------------------------------------
  flow:

    enabled: true

    train_dataset: phlux_lab/data/synthetic/ClientA_flow_clean_train.csv
    test_dataset:  phlux_lab/data/synthetic/ClientA_flow_clean_test.csv

    inputs:
      - suction_pressure
      - discharge_pressure
      - speed
      - temperature
      - fluid_density
      - fluid_viscosity
      - valve_opening
      - pump_power

    targets:
      - q_liquid

    target_ranges:
      q_liquid: [0.0, 150.0]

    model:
      type: ann
      hidden_layers: [64, 64, 64]
      activation: relu
      output_activation: linear

    save:
      model_name: vfm_flow.keras
      preprocessor: preprocessor_flow.joblib


  # --------------------------------------------------------------------
  # WEAR MODEL (STACKED ON FLOW)
  # --------------------------------------------------------------------
  wear:

    enabled: true

    train_dataset: phlux_lab/data/synthetic/ClientA_wear_train.csv
    test_dataset:  phlux_lab/data/synthetic/ClientA_wear_test.csv

    inputs:
      - suction_pressure
      - discharge_pressure
      - speed
      - temperature
      - valve_opening
      - q_liquid_pred
      - pump_power

    stack_inputs:
      - q_liquid_pred

    targets:
      - hydraulic_wear

    target_ranges:
      hydraulic_wear: [0.0, 0.15] # should equal what the model is trained on

    model:
      type: ann
      hidden_layers: [32, 32]
      activation: relu
      output_activation: sigmoid

    save:
      model_name: vfm_wear.keras
      preprocessor: preprocessor_wear.joblib


  # --------------------------------------------------------------------
  # FLOW CORRECTION MODEL (STACKED ON FLOW + WEAR)
  # --------------------------------------------------------------------
  flow_correction:

    enabled: true

    train_dataset: phlux_lab/data/synthetic/ClientA_paired_train.csv
    test_dataset:  phlux_lab/data/synthetic/ClientA_paired_test.csv

    inputs:
      - suction_pressure
      - discharge_pressure
      - speed
      - temperature
      - valve_opening
      - q_liquid_pred
      - hydraulic_wear_pred

    stack_inputs:
      - q_liquid_pred
      - hydraulic_wear_pred

    targets:
      - delta_q_liquid

    target_ranges:
      delta_q_liquid: [-20.0, 20.0]

    model:
      type: ann
      hidden_layers: [32, 32]
      activation: relu
      output_activation: linear

    save:
      model_name: vfm_flow_correction.keras
      preprocessor: preprocessor_flow_correction.joblib


# ======================================================================
# PIPELINE CONTROL FLAGS
# ======================================================================

pipeline:
  overwrite_datasets: true
  save_manifest: true
  manifest_name: model_manifest.yaml
